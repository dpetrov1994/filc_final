<?phpinclude ('../_template.php');include ".cfg.php";$content=file_get_contents("criar.tpl");$content=str_replace("_descricao_","",$content);/**Preenchimento dos itens do formulário **/// OBTER INFO DOS ORCAMENTOS$ArrayAssistencias = getInfoTabela('assistencias', 'and DATE_FORMAT(created_at, "%Y") = "'.$anoAtual.'" and ativo=1 order by id_assistencia*1 desc limit 1 ');$servico_n = $anoAtual.'/1';// SE EXISTIR ORCAMENTOif($ArrayAssistencias[0]){  // EXEMPLO - 2021/01    $dataDocumento = explode('/', $ArrayAssistencias[0]['nome_assistencia']); // $dataDocumento[0] é o ano    // SE O ANO ATUAL FOR IGUAL AO ANO DO DOCUMENTO    if($anoAtual == $dataDocumento[0]){        $servico_n = $anoAtual.'/'.($dataDocumento[1]+1);    }}$content=str_replace('_ordServico_',$servico_n, $content);include ("_criar_editar_detalhes.php");/**FIM Preenchimento dos itens do formulário **/if(isset($_POST['submit'])){    if($_POST['externa'] !=0){        $_POST['externa'] = 1;    }else{        $_POST['externa'] = 0;    }    if($_SESSION['id_utilizador']==1 && !isset($_POST['id_utilizador'])){        $_POST['id_utilizador']=$_SESSION['id_utilizador'];    }    $erros="";    $colunas="";    $valores="";    $scripts="";    if(isset($_FILES['file'])) {        $_POST['foto'] = carregar_foto($_FILES['file'], $cfg_tamanhoMaxUpload);    }    if(in_array('1', $_SESSION['grupos']) || in_array('2', $_SESSION['grupos'])){ // System ou Admin        $_POST['pendente'] = 0;    }    if($_POST['externa'] == 0){        $_POST['pendente'] = 0;    }    $return=colunas_valores_criar($_POST,$db,$itensIgnorar,$itensObrigatorios,$subModulo,$colunaParent,$idParent);    $erros=$return['erros'];    $colunas=$return['colunas'];    $valores=$return['valores'];    /**Validação de itens adicionais**/    /**FIM validação de itens adicionais**/    if($erros==""){        $sql="insert into $nomeTabela ($colunas,id_criou,created_at) values ($valores,'".$_SESSION['id_utilizador']."','".current_timestamp."')";        $result=runQ($sql,$db,"INSERT");        $insert_id=$db->insert_id;        /**Operações adicionais que necessitem do $insert_id **/        /**FIM perações adicionais que necessitem do $insert_id **/        $sql="select * from $nomeTabela where id_$nomeColuna = $insert_id";        $result=runQ($sql,$db,"SELECT INSERTED");        while ($row = $result->fetch_assoc()) {            $array_log=json_encode($row);            criarLog($db,$nomeTabela,"id_$nomeColuna",$insert_id,"Criar",$array_log);        }        if(isset($_GET['dashboard']) && $_GET['dashboard'] == "1"){            $location="../mod_inicio/dashboard.php?cod=1";        }else{            $location="editar.php?$addUrl&cod=3";            if($subModulo==0){                $location.="&id=$insert_id";            }else{                $location.="&subItemID=$insert_id";            }        }    }else{        $erros.=" Falta de dados para processar pedido.";        $location="criar.php$addUrl&cod=2&erro=$erros";    }    header("location: $location");}$pageScript='<script src="criar.js"></script>';include ('../_autoData.php');