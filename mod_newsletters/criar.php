<?phpinclude ('../_template.php');include ".cfg.php";if(isset($_GET['newsletter_qnt'])){    $qnt=$db->escape_string($_GET['newsletter_qnt']);    $tpl_pt="Exmo. Senhores Clientes<br><br>Também este ano e a exemplo de anos anteriores, comunica-se que a Ela Lda, vai estarencerrada, para férias do pessoal, no seguinte período:<br><b>Encerramento: Quinta-feira, dia 23 dezembro de 2021, às 18 horas.</b><br><b>Reabertura: Segunda-Feira, dia 03 janeiro de 2021, às 9 horas</b><br>Para um eficaz e organizado tratamento de encomendas, solicita-se que os vossospedidos cheguem aos nossos serviços administrativos até ao dia 23 dezembro (quinta-feira) às 18H.<br><br><div style='text-align: center'>    <img style='width: 50%' src='https://$domain/mod_newsletters/img/natal.jpg'></div>    ";    $tpl_es="Hola, estimados clientes<br><br>También este año, como en años anteriores, se anuncia que Ela Iberia Lda estarácerrada por vacaciones del personal en el siguiente período:<br><b>Cierre: jueves 23 de diciembre de 2021, a las 18pm</b><br><b>Reapertura: lunes 3 de enero de 2021, a las 9am</b><br>Para un procesamiento eficiente y organizado de los pedidos, solicitamos que suspedidos lleguen a nuestros servicios administrativos antes del 23 de diciembre (jueves)a las 18:00 horas.<br><br><div style='text-align: center'>    <img style='width: 50%' src='https://$domain/mod_newsletters/img/natales.jpg'></div>    ";    $assunto_pt="Férias festivas";    $assunto_es="Tiempo festivos - Navidad y Año Nuevo";    $cnt=0;    $emails="";    $sql="select * from srv_clientes where ativo=1";    $result=runQ($sql,$db,1);    while($row = $result->fetch_assoc()){        if($cnt<$qnt){            $pais=json_decode($row['pais']);            $data="PRT";            if(is_array($pais)){                foreach ($pais as $p){                    if($p=="ESP"){                        $data="ESP";                    }                }            }            if($data=="PRT"){                $tpl=$tpl_pt;                $assunto=$assunto_pt;            }else{                $tpl=$tpl_es;                $assunto=$assunto_es;            }            $sql2="select * from srv_clientes_email where PartyID='".$row['PartyID']."' and EmailAddress!=''";            $result2=runQ($sql2,$db,2);            while($row2 = $result2->fetch_assoc()){                $sql3="select * from newsletters where email='".$row2['EmailAddress']."' and (nome_newsletter='$assunto_pt' or nome_newsletter='$assunto_es')";                $result3=runQ($sql3,$db,3);                if($result3->num_rows==0){                    $emails.="$cnt - ".$row['PartyID']." ($data):  ".$row2['EmailAddress']."<br>";                    $cnt++;                    enviarEmail([],$assunto,$tpl,[$row2['EmailAddress']]);                    $sql4="insert into newsletters (nome_newsletter, email, id_cliente) values ('$assunto','".$row2['EmailAddress']."','".$row['PartyID']."')";                    $result4=runQ($sql4,$db,4);                }            }        }else{            break;        }    }    print "-".current_timestamp."<br>";    print $emails."<br><br><hr>";    die();die();}$content=file_get_contents("criar.tpl");$content=str_replace("_descricao_","",$content);/**Preenchimento dos itens do formulário **/include ("_criar_editar_detalhes.php");/**FIM Preenchimento dos itens do formulário **/if(isset($_POST['submit'])){    $erros="";    $colunas="";    $valores="";    $scripts="";    if(isset($_FILES['file'])) {        $_POST['foto'] = carregar_foto($_FILES['file'], $cfg_tamanhoMaxUpload);    }    $return=colunas_valores_criar($_POST,$db,$itensIgnorar,$itensObrigatorios,$subModulo,$colunaParent,$idParent);    $erros=$return['erros'];    $colunas=$return['colunas'];    $valores=$return['valores'];    /**Validação de itens adicionais**/    /**FIM validação de itens adicionais**/    if($erros==""){        $sql="insert into $nomeTabela ($colunas,id_criou,created_at) values ($valores,'".$_SESSION['id_utilizador']."','".current_timestamp."')";        $result=runQ($sql,$db,"INSERT");        $insert_id=$db->insert_id;        /**Operações adicionais que necessitem do $insert_id **/        //        /**FIM perações adicionais que necessitem do $insert_id **/        $sql="select * from $nomeTabela where id_$nomeColuna = $insert_id";        $result=runQ($sql,$db,"SELECT INSERTED");        while ($row = $result->fetch_assoc()) {            $array_log=json_encode($row);            criarLog($db,$nomeTabela,"id_$nomeColuna",$insert_id,"Criar",$array_log);        }        $location="editar.php?$addUrl&cod=3";        if($subModulo==0){            $location.="&id=$insert_id";        }else{            $location.="&subItemID=$insert_id";        }    }else{        $erros.=" Falta de dados para processar pedido.";        $location="criar.php$addUrl&cod=2&erro=$erros";    }    header("location: $location");}$pageScript='<script src="criar.js"></script>';include ('../_autoData.php');