<?phpinclude ('../_template.php');include ".cfg.php";if(isset($_GET['criar_cliente']) && $_GET['criar_cliente'] == 1){    $contentClientes=file_get_contents("../mod_clientes/criar.tpl");    $contentClientes = str_replace('form-para-validar', 'form-cliente', $contentClientes);    $contentClientes=str_replace("_descricao_","",$contentClientes);    $contentClientes=str_replace("criar.php_addUrl_","../mod_clientes/criar.php?ajax",$contentClientes);    $contentClientes=str_replace("botao_loading","botao_loading_cliente",$contentClientes);    echo $contentClientes;    die;}$content=file_get_contents("criar.tpl");$content=str_replace("_descricao_","",$content);// OBTER INFO DOS ORCAMENTOS$ArrayOrcamentos = getInfoTabela('orcamentos', 'and ativo=1 order by id_orcamento*1 desc limit 1 ');$refOrcamento = $anoAtual.'/1';// SE EXISTIR ORCAMENTOif($ArrayOrcamentos[0]){  // EXEMPLO - 2021/01    $dataDocumento = explode('/', $ArrayOrcamentos[0]['ref']); // $dataDocumento[0] é o ano   // SE O ANO ATUAL FOR IGUAL AO ANO DO DOCUMENTO    if($anoAtual == $dataDocumento[0]){        $refOrcamento = $anoAtual.'/'.($dataDocumento[1]+1);    }}$content=str_replace('_ordDocumento_',$refOrcamento, $content);/**Preenchimento dos itens do formulário **/include ("_criar_editar_detalhes.php");/**FIM Preenchimento dos itens do formulário **/if(isset($_POST['submit'])){    $erros="";    $colunas="";    $valores="";    $scripts="";    if(isset($_FILES['file'])) {        $_POST['foto'] = carregar_foto($_FILES['file'], $cfg_tamanhoMaxUpload);    }    $return=colunas_valores_criar($_POST,$db,$itensIgnorar,$itensObrigatorios,$subModulo,$colunaParent,$idParent);    $erros=$return['erros'];    $colunas=$return['colunas'];    $valores=$return['valores'];    /**Validação de itens adicionais**/    /**FIM validação de itens adicionais**/    if($erros==""){        $sql="insert into $nomeTabela ($colunas,id_criou,created_at) values ($valores,'".$_SESSION['id_utilizador']."','".current_timestamp."')";        $result=runQ($sql,$db,"INSERT");        $insert_id=$db->insert_id;        /**Operações adicionais que necessitem do $insert_id **/        $dir="../_contents/$nomeTabela";        if(!is_dir($dir)){            mkdir($dir);        }        $dir="../_contents/$nomeTabela/$insert_id";        if(!is_dir($dir)){            mkdir($dir);        }        $dirUser = "../.tmp/".$_SESSION['id_utilizador'];        if(!is_dir($dirUser)){        mkdir($dirUser);        }        moverFicheiros($dirUser,$dir);        if(isset($_POST['nome_produto'])){            if(is_array($_POST['nome_produto'])){                foreach ($_POST['nome_produto'] as $key => $value){                    if($_POST['nome_produto'][$key]!=""){                        $e=array();                        $e['nome_produto']=$db->escape_string($_POST['nome_produto'][$key]);                        $e['quantidade']=$db->escape_string($_POST['quantidade'][$key]);                        $e['preco_sem_iva']=$db->escape_string($_POST['preco_sem_iva'][$key]);                        $e['percentagem_iva']=$db->escape_string($_POST['percentagem_iva'][$key]);                        $e['valor_iva']=$db->escape_string($_POST['valor_iva'][$key]);                        $e['valor_liquido']=$db->escape_string($_POST['valor_liquido'][$key]);                        $e['desconto']=$db->escape_string($_POST['desconto'][$key]);                        /*$insert_cols="";                        $insert_vals="";                        foreach ($e as $col=>$val){                            $insert_cols.="$col,";                            $insert_vals.="'$val',";                        }                        $insert_cols=substr($insert_cols, 0, -1);                        $insert_vals=substr($insert_vals, 0, -1);                        $sql="select * from produtos where nome_produto='".$e['nome_produto']."'";                        $result=runQ($sql,$db,"verificar se o produto existe");                        if($result->num_rows==0){                            $sql="insert into produtos ($insert_cols) values ($insert_vals)";                            $result=runQ($sql,$db,"inserir o produto");                            $e['id_produto']=$db->insert_id;                        }else{                            while ($row = $result->fetch_assoc()) {                                $e['id_produto']=$row['id_produto'];                            }                        }*/                        $sql="select * from produtos where nome_produto='".$e['nome_produto']."'";                        $result=runQ($sql,$db,"verificar se o produto existe");                        if($result->num_rows>0){                            while ($row = $result->fetch_assoc()) {                                $e['id_produto']=$row['id_produto'];                            }                        }                        $e['id_orcamento']=$insert_id;                        $insert_cols="";                        $insert_vals="";                        foreach ($e as $col=>$val){                            $insert_cols.="$col,";                            $insert_vals.="'$val',";                        }                        $insert_cols=substr($insert_cols, 0, -1);                        $insert_vals=substr($insert_vals, 0, -1);                        $sql="insert into orcamentos_linhas ($insert_cols) values ($insert_vals)";                        $result=runQ($sql,$db,"inserir as linhas do orçamento");                    }                }            }        }        /**FIM perações adicionais que necessitem do $insert_id **/        $sql="select * from $nomeTabela where id_$nomeColuna = $insert_id";        $result=runQ($sql,$db,"SELECT INSERTED");        while ($row = $result->fetch_assoc()) {            $array_log=json_encode($row);            criarLog($db,$nomeTabela,"id_$nomeColuna",$insert_id,"Criar",$array_log);        }        $location="editar.php?$addUrl&cod=3";        if($subModulo==0){            $location.="&id=$insert_id";        }else{            $location.="&subItemID=$insert_id";        }    }else{        $erros.=" Falta de dados para processar pedido.";        $location="criar.php$addUrl&cod=2&erro=$erros";    }    header("location: $location");}$pageScript='<script src="criar.js"></script>';include ('../_autoData.php');